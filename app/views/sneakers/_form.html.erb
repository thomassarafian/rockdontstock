<%= simple_form_for(sneaker.new_record? ? [sneaker_db, sneaker] : sneaker, id: 'newSneakerForm') do |f| %>
  <div class="info-input">
  	 <%= f.input :size, collection: [ ["1", 1], ["1.5", 1.5], ["2", 2], ["2.5", 2.5], ["3", 3], ["3.5", 3.5], ["4", 4], ["4.5", 4.5], 
        ["5", 5], ["5.5", 5.5], ["6", 6], ["6.5", 6.5], ["7", 7], ["7.5", 7.5], ["8", 8], ["8.5", 8.5], ["9", 9], ["9.5", 9.5],
        ["10", 10], ["10.5", 10.5], ["11", 11], ["11.5", 11.5], ["12",12], ["12.5", 12.5], ["13", 13], ["13.5", 13.5],
        ["14", 14], ["14.5", 14.5], ["15", 15], ["16", 16], ["17", 17], ["18", 18] ], required: true, prompt: "Taille US", 
        label: false, input_html: { class: "info-input-sneaker" } %>

  	<%= f.input :condition, prompt: "Condition", collection: [ ["5/10 et moins", 5], ["6/10", 6],["8/10", 8],["9/10",9],['10/10', 10] ], required: true, label: false,
    input_html: { class: "info-input-sneaker" }  %>

  	<%= f.input :box, prompt: "Box", collection: ["Og Box", "Boite de remplacement", "Pas de boite"], required: true, label: false, input_html: { class: "info-input-sneaker" }  %>

  	<%= f.input :extras, required: true, placeholder: "Commentaires", label: false,
    input_html: { class: "info-input-sneaker" }  %>


    <%= f.input :price, required: true, placeholder: "Prix", label: false,
    input_html: { class: "info-input-sneaker", value: nil} %>
    <%= f.error :price, :id => "price-sneaker-error" %>

    <div clas="total-price-for-seller">
      <p></p>
    </div>
  </div>

  <div class="next-btn">
    <button type="button" class="btn btn-dark">Suivant</button>
  </div>
  

  <div class="photos-input">
    <div class='sneaker-photo-input'>
      <%= f.file_field :photos, as: :file,  onchange:"uploadPhotos()",
      class: "hidden", id: 'photo-input0',
      class: 'upload-photo photo-input0',
      label: 'üì∑ Ajoute une photo'%>
      <%= image_tag "", width: 0, class: "hidden", id: "photo-preview0" %>
      <%= f.label :photos, "Int√©rieur" %>
    </div>
    <div class='sneaker-photo-input'>
      <%= f.file_field :photos, as: :file,  onchange:"uploadPhotos()",
      class: "hidden", id: 'photo-input1',
      class: 'upload-photo photo-input1',
      label: 'üì∑ Ajoute une photo' %>
      <%= image_tag "", width: 0, class: "hidden", id: "photo-preview1" %>
      <%= f.label :photos, "Ext√©rieur"  %>
    </div>
    <div class='sneaker-photo-input'>
      <%= f.file_field :photos, as: :file,  onchange:"uploadPhotos()",
      class: "hidden", id: 'photo-input2',
      class: 'upload-photo photo-input2',
      label: 'üì∑ Ajoute une photo' %>
      <%= image_tag "", width: 0, class: "hidden", id: "photo-preview2" %>
      <%= f.label :photos, "Derri√®re"  %>
    </div>
    <div class='sneaker-photo-input'>
      <%= f.file_field :photos, as: :file,  onchange:"uploadPhotos()",
      class: "hidden", id: 'photo-input3',
      class: 'upload-photo photo-input3',
      label: 'üì∑ Ajoute une photo' %>
      <%= image_tag "", width: 0, class: "hidden", id: "photo-preview3" %>
      <%= f.label :photos, "Dessus"  %>
    </div>
    <div class='sneaker-photo-input'>
      <%= f.file_field :photos, as: :file,  onchange:"uploadPhotos()",
      class: "hidden", id: 'photo-input4',
      class: 'upload-photo photo-input4',
      label: 'üì∑ Ajoute une photo' %>
      <%= image_tag "", width: 0, class: "hidden", id: "photo-preview4" %>
      <%= f.label :photos, "Dessous"  %>
    </div>
    <div class='sneaker-photo-input'>
      <%= f.file_field :photos, as: :file,  onchange:"uploadPhotos()",
      class: "hidden", id: 'photo-input5',
      class: 'upload-photo photo-input5',
      label: 'üì∑ Ajoute une photo' %>
      <%= image_tag "", width: 0, class: "hidden", id: "photo-preview5" %>
      <%= f.label :photos, "Boite"  %>
    </div>
    <div class='sneaker-photo-input'>
      <%= f.file_field :photos, as: :file,  onchange:"uploadPhotos()",
      class: "hidden", id: 'photo-input6',
      class: 'upload-photo photo-input6',
      label: 'üì∑ Ajoute une photo' %>
      <%= image_tag "", width: 0, class: "hidden", id: "photo-preview6" %>
      <%= f.label :photos, "Size tag"  %>
    </div>
    <div class='sneaker-photo-input'>
      <%= f.file_field :photos, as: :file,  onchange:"uploadPhotos()",
      class: "hidden", id: 'photo-input7',
      class: 'upload-photo photo-input7',
      label: 'üì∑ Ajoute une photo' %>
      <%= image_tag "", width: 0, class: "hidden", id: "photo-preview7" %>
      <%= f.label :photos, "D√©faults sur la paire"  %>
    </div>
  </div>
  <div class="snd-next-btn">
    <button type="button" class="btn btn-dark">Suivant</button>
  </div>




<script type="text/javascript">
  let opti_photos = []
  window.uploadPhotos = function(url){
    var file = event.target.files[0];

    // Ensure it's an image
    if(file.type.match(/image.*/)) {
        console.log('An image has been loaded');

        // Load the image
        var reader = new FileReader();
        reader.onload = function (readerEvent) {
            var image = new Image();
            image.onload = function (imageEvent) {

                // Resize the image
                var canvas = document.createElement('canvas'),
                    max_size = 544,// TODO : pull max size from a site config
                    width = image.width,
                    height = image.height;
                if (width > height) {
                    if (width > max_size) {
                        height *= max_size / width;
                        width = max_size;
                    }
                } else {
                    if (height > max_size) {
                        width *= max_size / height;
                        height = max_size;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                canvas.getContext('2d').drawImage(image, 0, 0, width, height);
                var dataUrl = canvas.toDataURL('image/jpeg');
                var resizedImage = dataURLToBlob(dataUrl);
                $.event.trigger({
                    type: "totoEoh",
                    blob: resizedImage,
                    url: dataUrl
                });
            }
            image.src = readerEvent.target.result;
        }
        reader.readAsDataURL(file);
    }
};

var dataURLToBlob = function(dataURL) {
  var BASE64_MARKER = ';base64,';
  if (dataURL.indexOf(BASE64_MARKER) == -1) {
      var parts = dataURL.split(',');
      var contentType = parts[0].split(':')[1];
      var raw = parts[1];
      return new Blob([raw], {type: contentType});
  }
  var parts = dataURL.split(BASE64_MARKER);
  var contentType = parts[0].split(':')[1];
  var raw = window.atob(parts[1]);
  var rawLength = raw.length;
  var uInt8Array = new Uint8Array(rawLength);
  for (var i = 0; i < rawLength; ++i) {
      uInt8Array[i] = raw.charCodeAt(i);
  }

  return new Blob([uInt8Array], {type: contentType});
}

  $(document).on("totoEoh", function (event) {
    console.log("Uploaded the photo and pushed to opti photos ");
    if (event.blob && event.url) {
        opti_photos.push(event.blob);
    }
  });

  document.querySelector('.snd-next-btn').addEventListener('click', (e) => {
    var data = new FormData($("form[id*='newSneakerForm']")[0]);
    console.log("On cr√©e data !")
    data.append('sneaker[size]', document.getElementById('sneaker_size').value);
    data.append('sneaker[condition]', document.getElementById('sneaker_condition').value);
    data.append('sneaker[box]', document.getElementById('sneaker_box').value);
    data.append('sneaker[extras]', document.getElementById('sneaker_extras').value);
    data.append('sneaker[price]', document.getElementById('sneaker_price').value);
    opti_photos.forEach(elem => {
      data.append('sneaker[photos][]', elem);
    });
    fetch(document.getElementById('new_sneaker').action, {
      method: "POST",
      body: data,
    })
  });


</script>

  <div class="summary-new-sneaker">
    <div class='summary-photo'>
      <div id="carouselSummaryNewSneaker" class="carousel slide" data-ride="carousel">
        <div class="carousel-inner">
          <div class="carousel-item active carousel-sneaker-photo0"></div>
          <div class="carousel-item carousel-sneaker-photo1"></div>
          <div class="carousel-item carousel-sneaker-photo2"></div>
          <div class="carousel-item carousel-sneaker-photo3"></div>
          <div class="carousel-item carousel-sneaker-photo4"></div>
          <div class="carousel-item  carousel-sneaker-photo5"></div>
          <div class="carousel-item carousel-sneaker-photo6"></div>
          <div class="carousel-item carousel-sneaker-photo7"></div>
        </div>
        <a class="carousel-control-prev" href="#carouselSummaryNewSneaker" role="button" data-slide="prev">
          <span class="carousel-control-prev-icon sneaker-show-prev-icon" aria-hidden="true"></span>
          <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#carouselSummaryNewSneaker" role="button" data-slide="next">
          <span class="carousel-control-next-icon sneaker-show-next-icon" aria-hidden="true"></span>
          <span class="sr-only">Next</span>
        </a>
      </div>
      <div class="summary-new-sneaker-infos">
        <div class='summary-name'>
         <p>Mod√®le : <strong><%= @sneaker_db.name %></strong></p>
        </div>
        <div class='summary-size'></div>
        <div class='summary-cond'></div>
        <div class='summary-extras'></div>
        <div class='summary-box'></div>
      </div>
    </div>
    <div class="summary-new-sneaker-resume"> 
      <div class="summary-new-sneaker-price">
        <div class="summary-price-seller"></div>
        <div class="summary-price-check"></div>
        <div class="summary-price-shipping">
          <p class="summary-price-sneaker">Exp√©dition : <span id="summary-price-shipping">4.99‚Ç¨</span></p>
        </div>
        <hr>
        <div class="summary-price-total">   
        </div>
        <div class="submit-new-sneaker">
          <!-- <a id="final-sell"style="margin: 50px 0;"href="/">Finaliser la vente ! </a> -->
          <button name="button-new-sneaker" value="Finaliser la mise en vente" class="btn finish-sneaker-new-btn text-center btn btn-dark" data-disable-with="<i class='fas fa-spinner fa-spin'></i> Chargement ...">Finaliser la mise en vente</button>
        </div>
      </div>
    </div>
  </div>

<% end %>

<style type="text/css">
  /*.info-input-sneaker:focus {
    outline:none;
    outline-width: 0;
  }*/
  .finish-sneaker-new-btn {
    font-size: 13px;
    padding: 5px 10px;
  }
  .next-btn, .snd-next-btn {
    text-align: center;
  }
  .snd-next-btn {
    float: right;
  }
  .next-btn {
    margin-top: 30px;
    margin-left: 173px;
  }
  .info-input-sneaker {
    width: 250px;
    margin: 10px 0;
  }
  .info-input {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .sneaker-photo-input {
    display: flex;
    text-align: center;
    flex-direction: column;
  }
  .submit-new-sneaker {
    text-align: center;
  }
  .upload-photo {
    width: 200px;
    height: 200px;
    background-position: center;
    background-repeat: no-repeat;
    background-size: contain;
  }
  .photo-input0 {
    background-image: url(/assets/sneaker_new/1.jpg);
  }
  .photo-input1 {
    background-image: url(/assets/sneaker_new/2.jpg);
  }
  .photo-input2 {
    background-image: url(/assets/sneaker_new/3.jpg);
  }
  .photo-input3 {
    background-image: url(/assets/sneaker_new/4.jpg);
  }
  .photo-input4 {
    background-image: url(/assets/sneaker_new/5.jpg);
  }
  .photo-input5 {
    background-image: url(/assets/sneaker_new/6.jpg);
  }
  .photo-input6 {
    background-image: url(/assets/sneaker_new/7.jpg);
  }
  .photo-input7 {
    background-image: url(/assets/sneaker_new/8.jpg);
  }
  
  .photos-input {
    display: flex;
    flex-wrap: wrap;
    flex-direction: row;
    align-items: center;
    justify-content: center;
  }

  .upload-photo {
    margin: 20px 20px;
  }
</style>
<style type="text/css">
  .search-sneaker-model {
    min-height: 100vh;
  }
  .sneaker_price, #sneaker_price {
    margin-bottom: 0;
  }
  
  #price-sneaker-error {
    width: 250px;
    visibility: hidden;
    color: #e74c3c;
  }
  @media (min-width: 320px) {
    .search-sneaker-model-title {
      font-size: 30px;
    }
    .summary-name>p, .summary-size>p, .summary-cond>p, .summary-extras>p, .summary-box>p {
      margin-bottom: 5px;
    }
    .summary-new-sneaker-infos {
      font-size: 12px;
      margin-bottom: 30px;
    }
    .summary-price-sneaker {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    .submit-new-sneaker {
      grid-column: 1 / 3;
      margin-top: 30px;
    }

  }
  @media (min-width: 768px) {
    .summary-new-sneaker-resume {
      font-size: 12px;
      width: 250px
    }
    .submit-new-sneaker {
      grid-column: 2 / 3;
    }
    .summary-new-sneaker {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      justify-items: center;
      align-items: center;
    }
  }
  @media (min-width: 1024px) {
    .summary-new-sneaker-resume {
      width: 400px
    }
  }
  @media (min-width: 1440px) {
    .summary-new-sneaker-resume {
      width: 500px
    }
  }

</style>

<script type="text/javascript">
  document.querySelector('.photos-input').style.display = "none";
  document.querySelector('.next-btn').style.display = "none";
  document.querySelector('.snd-next-btn').style.display = "none";
  document.querySelector('.submit-new-sneaker').style.display = "none"
  document.querySelector('.summary-new-sneaker').style.display = "none"

  document.getElementById('sneaker_price').addEventListener('input', (event) => {
    function checkInputs() {
      if (sneaker_price.value.match(/[^0-9,]/g)) {
        setErrorFor(sneaker_price, "<small>Le prix ne doit contenir que des chiffres et/ou une virgule. Ex: 199,99 ou 199</small>");
        return -1;
      }
    }
    function setErrorFor(input, message) {
      const priceSneakerError = document.querySelector('#price-sneaker-error');
      priceSneakerError.style.visibility = "visible";
      priceSneakerError.innerHTML = message;
      document.querySelector('#sneaker_price').classList.add("is-invalid");
    }
    let photosInput = document.querySelector('.photos-input');
    let infoInput =  document.querySelector('.info-input');
    let submitSneaker = document.querySelector('.submit-new-sneaker');
    let nextBtn = document.querySelector('.next-btn');
    
    
    if (sneaker_size.value && sneaker_price.value && sneaker_condition.value && sneaker_box.value) {
      // document.querySelector('.total-price-for-seller').innerHTML = `<p>Box : ${sneaker_price.value}</p>`;
      nextBtn.style.display = "block";
      nextBtn.addEventListener('click', (event) => {
        if (checkInputs() == -1) {}
        else {
          photosInput.style.display = "flex";
          submitSneaker.style.display = "block";
          infoInput.style.display = "none";
          nextBtn.style.display = "none";
        }
      })
    } 
  });

  document.querySelector('.next-btn').addEventListener('click', (event) => {
    let photoPreview0 = document.getElementById('photo-preview0');
    let photoPreview1 = document.getElementById('photo-preview1');
    let photoPreview2 = document.getElementById('photo-preview2');
    let photoPreview3 = document.getElementById('photo-preview3');
    let photoPreview4 = document.getElementById('photo-preview4');
    let photoPreview5 = document.getElementById('photo-preview5');
    let photoPreview6 = document.getElementById('photo-preview6');
    let photoPreview7 = document.getElementById('photo-preview7');
    let photoPreview = 0;

    photoPreview0.addEventListener('load', (event) => {
      let photoInput0 = document.querySelector('.photo-input0');
      photoInput0.style.backgroundImage = `url(${photoPreview0.src})`;
      photoPreview++;
    })
    photoPreview1.addEventListener('load', (event) => {
      let photoInput1 = document.querySelector('.photo-input1');
      photoInput1.style.backgroundImage = `url(${photoPreview1.src})`;
      photoPreview++;
    })
    photoPreview2.addEventListener('load', (event) => {
      let photoInput2 = document.querySelector('.photo-input2');
      photoInput2.style.backgroundImage = `url(${photoPreview2.src})`;
      photoPreview++;
    })
    photoPreview3.addEventListener('load', (event) => {
      let photoInput3 = document.querySelector('.photo-input3');
      photoInput3.style.backgroundImage = `url(${photoPreview3.src})`;
      photoPreview++;
    })
    photoPreview4.addEventListener('load', (event) => {
      let photoInput4 = document.querySelector('.photo-input4');
      photoInput4.style.backgroundImage = `url(${photoPreview4.src})`;
      photoPreview++;
    })
    photoPreview5.addEventListener('load', (event) => {
      let photoInput5 = document.querySelector('.photo-input5');
      photoInput5.style.backgroundImage = `url(${photoPreview5.src})`;
      photoPreview++;
    })
    photoPreview6.addEventListener('load', (event) => {
      let photoInput6 = document.querySelector('.photo-input6');
      photoInput6.style.backgroundImage = `url(${photoPreview6.src})`;
      photoPreview++;
    })
    photoPreview7.addEventListener('load', (event) => {
      let photoInput7 = document.querySelector('.photo-input7');
      photoInput7.style.backgroundImage = `url(${photoPreview7.src})`;
      photoPreview++;
      if (photoPreview == 8) {
        let sndNextBtn = document.querySelector('.snd-next-btn');
        sndNextBtn.style.display = "block";
        sndNextBtn.addEventListener('click', (event) => {
          let photosInput = document.querySelector('.photos-input');
          let summaryNewSneaker = document.querySelector('.summary-new-sneaker');
          photosInput.style.display = "none";
          if (window.innerWidth >= 768) {
            summaryNewSneaker.style.display = "grid";
          } else {
            summaryNewSneaker.style.display = "block";
          }
          sndNextBtn.style.display = "none";
          document.querySelector('.submit-new-sneaker').style.display = "block"
          document.querySelector('.search-sneaker-model-title').innerText = "R√©capitulatif de la commande";
          document.querySelector('.carousel-sneaker-photo0').innerHTML = `<img src="${photoPreview0.src}" class="sneaker-show-photos">`;
          document.querySelector('.carousel-sneaker-photo1').innerHTML = `<img src="${photoPreview1.src}" class="sneaker-show-photos">`;
          document.querySelector('.carousel-sneaker-photo2').innerHTML = `<img src="${photoPreview2.src}" class="sneaker-show-photos">`;
          document.querySelector('.carousel-sneaker-photo3').innerHTML = `<img src="${photoPreview3.src}" class="sneaker-show-photos">`;
          document.querySelector('.carousel-sneaker-photo4').innerHTML = `<img src="${photoPreview4.src}" class="sneaker-show-photos">`;
          document.querySelector('.carousel-sneaker-photo5').innerHTML = `<img src="${photoPreview5.src}" class="sneaker-show-photos">`;
          document.querySelector('.carousel-sneaker-photo6').innerHTML = `<img src="${photoPreview6.src}" class="sneaker-show-photos">`;
          document.querySelector('.carousel-sneaker-photo7').innerHTML = `<img src="${photoPreview7.src}" class="sneaker-show-photos">`;
          document.querySelector('.summary-size').innerHTML = `<p>Taille : ${sneaker_size.value}</p>`;
          document.querySelector('.summary-cond').innerHTML = `<p>Condition : ${sneaker_condition.value} / 10</p>`;
          document.querySelector('.summary-extras').innerHTML = `<p>Extras : ${sneaker_extras.value}</p>`;
          document.querySelector('.summary-box').innerHTML = `<p>Box : ${sneaker_box.value}</p>`;
          document.querySelector('.summary-price-seller').innerHTML = `<p class="summary-price-sneaker">Prix demand√© : 
          <span id="summary-price-seller">${sneaker_price.value}‚Ç¨</span></p>`;
          let summaryPriceCheck = ((parseFloat(sneaker_price.value.replace(/,/g, ".")) *0.12)/2).toFixed(2);
          document.querySelector('.summary-price-check').innerHTML = `<p class="summary-price-sneaker">Frais d‚Äôauthentification :
          <span id="summary-price-check">${summaryPriceCheck}‚Ç¨</span></p>`;
          let summaryPriceTotal = parseFloat( 
            // ((parseFloat(sneaker_price.value.replace(/,/g, ".")) *0.12)/2) + 
            parseFloat(sneaker_price.value.replace(/,/g, ".") ) - 4.99 ).toFixed(2);
          document.querySelector('.summary-price-total').innerHTML = `<strong><p class="summary-price-sneaker">TOTAL : 
          <span id="summary-price-total">${summaryPriceTotal}‚Ç¨</span></p></strong>`
        });
      }
    })
  })  
</script>


<style type="text/css">
  #summary-price-check {
    text-decoration: line-through;
  }
</style>

