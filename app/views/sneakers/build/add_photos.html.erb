<div class="container">
  <div class="sale-wizard__subtitle">Etape 3</div>
  <h2 class="sale-wizard__title">Vendre ma paire</h2>
  <div class="sale-wizard__progress">
    <div class="sale-wizard__progress__step">
      <div class="sale-wizard__progress__step-title--complete">Modèle</div>
      <div class="sale-wizard__progress__step-display--complete"></div>
    </div>
    <div class="sale-wizard__progress__step">
      <div class="sale-wizard__progress__step-title--complete">Informations</div>
      <div class="sale-wizard__progress__step-display--complete"></div>
    </div>
    <div class="sale-wizard__progress__step">
      <div class="sale-wizard__progress__step-title--active">Photos</div>
      <div class="sale-wizard__progress__step-display--active"></div>
    </div>
    <div class="sale-wizard__progress__step">
      <div class="sale-wizard__progress__step-title">Récapitulatif</div>
      <div class="sale-wizard__progress__step-display"></div>
    </div>
  </div>
  <div class="upload-content">
    <div class="d-flex flex-column">
      <div>
        <div style="font-weight: 700">
          Importe tes photos
        </div>
        <div style="font-size: 0.8rem">
          <i class="fas fa-exclamation-circle ml-0"></i> Attention : les photos que tu implémentes doivent respecter l’ordre et les angles présentés ci-dessous. Dans le cas contraire, ton annonce ne sera pas validée.
        </div>
      </div>
      <div class="sneaker-form__photos">
        <div class="sneaker-form__photo sneaker-form__photo-0">
          <img id="preview-photo-0" class="sneaker-form__photo__preview" src="" />
          <%= file_field_tag :photos, multiple: true, class: "sneaker-form__photo__input" %>
          <img class="sneaker-form__photo__btn" src="/assets/images/upload-banner.png" />
          <%= label_tag "Intérieur" %>
        </div>
        <div class="sneaker-form__photo sneaker-form__photo-1">
          <img id="preview-photo-1" class="sneaker-form__photo__preview" src="" />
          <%= file_field_tag :photos, multiple: true, class: "sneaker-form__photo__input" %>
          <img class="sneaker-form__photo__btn" src="/assets/images/upload-banner.png" />
          <%= label_tag "Extérieur" %>
        </div>
        <div class="sneaker-form__photo sneaker-form__photo-2">
          <img id="preview-photo-2" class="sneaker-form__photo__preview" src="" />
          <%= file_field_tag :photos, multiple: true, class: "sneaker-form__photo__input" %>
          <img class="sneaker-form__photo__btn" src="/assets/images/upload-banner.png" />
          <%= label_tag "Derrière" %>
        </div>
        <div class="sneaker-form__photo sneaker-form__photo-3">
          <img id="preview-photo-3" class="sneaker-form__photo__preview" src="" />
          <%= file_field_tag :photos, multiple: true, class: "sneaker-form__photo__input" %>
          <img class="sneaker-form__photo__btn" src="/assets/images/upload-banner.png" />
          <%= label_tag "Dessus" %>
        </div>
        <div class="sneaker-form__photo sneaker-form__photo-4">
          <img id="preview-photo-4" class="sneaker-form__photo__preview" src="" />
          <%= file_field_tag :photos, multiple: true, class: "sneaker-form__photo__input" %>
          <img class="sneaker-form__photo__btn" src="/assets/images/upload-banner.png" />
          <%= label_tag "Dessous" %>
        </div>
        <div class="sneaker-form__photo sneaker-form__photo-5">
          <img id="preview-photo-5" class="sneaker-form__photo__preview" src="" />
          <%= file_field_tag :photos, multiple: true, class: "sneaker-form__photo__input" %>
          <img class="sneaker-form__photo__btn" src="/assets/images/upload-banner.png" />
          <%= label_tag "Size Tag" %>
        </div>
        <div class="sneaker-form__photo sneaker-form__photo-6">
          <img id="preview-photo-6" class="sneaker-form__photo__preview" src="" />
          <%= file_field_tag :photos, multiple: true, class: "sneaker-form__photo__input" %>
          <img class="sneaker-form__photo__btn" src="/assets/images/upload-banner.png" />
          <%= label_tag "Optionnel : boîte" %>
        </div>
        <div class="sneaker-form__photo sneaker-form__photo-7">
          <img id="preview-photo-7" class="sneaker-form__photo__preview" src="" />
          <%= file_field_tag :photos, multiple: true, class: "sneaker-form__photo__input" %>
          <img class="sneaker-form__photo__btn" src="/assets/images/upload-banner.png" />
          <%= label_tag "Optionnel : défauts sur la paire" %>
        </div>
      </div>
    </div>
    <%= form_for @sneaker, url: wizard_path, method: :put do |f| %>
      <%= f.hidden_field :id %>
      <div class="sneaker-form__btns" style="margin-top: 6rem;">
        <%= link_to "Précédent", previous_wizard_path, class: "sneaker-form__previous-btn" %>
        <button class="sneaker-form__next-btn">
          Suivant <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    <% end %>
  </div>
  <div class="loader-wrapper" style="display: none; margin: 100px auto; width: 50%; text-align: center;">
    <div class="loader"></div>
    <div>Merci de ne pas quitter la page, tes photos sont en train de s'envoyer !</div>
  </div>
</div>

<script>
  const submitBtn = document.querySelector('.sneaker-form__next-btn')
  const form = submitBtn.closest('form')
  const loader = document.querySelector('.loader-wrapper')
  let resizedPhotos = new Array

  form.addEventListener('submit', function(e) {
    e.preventDefault();

    const uploadContent = document.querySelector('.upload-content')
    const uploadElements = Array.from(document.querySelectorAll('.sneaker-form__photo__input'))
    const requiredUploads = uploadElements.slice(0, 6)
    
    // if (!requiredUploads.every(el => el.value)) {
    //   scrollUp()
    //   return;
    // }

    uploadContent.style.display = "none"
    loader.style.display = ""

    const formData = new FormData();
    formData.append('sneaker[q]', 'q')
    resizedPhotos.forEach(el => formData.append('sneaker[photos][]', el))

    Rails.ajax({
      type: 'PUT',
      url: '<%= wizard_path %>',
      dataType: 'json',
      data: formData,
      success: () => form.submit(),
      error: (err) => {
        alert(err.error);
        uploadContent.style.display = "block"
        loader.style.display = "none"
        scrollUp()
      }
    })
  })

  document.querySelectorAll('.sneaker-form__photo__input').forEach((input, index) => {
    let preview = document.getElementById("preview-photo-" + index)

    input.addEventListener('change', _ => {
      const [file] = input.files
      if (file) {
        preview.style.visibility = "visible"
        preview.src = URL.createObjectURL(file)
      }

      resizeImage(file).then((resizedPhoto) => {
        resizedPhotos[index] = resizedPhoto
      })
    })
  })

  function resizeImage(file) {
    var maxSize = 700;
    var reader = new FileReader();
    var image = new Image();
    var canvas = document.createElement('canvas');

    function dataURItoBlob(dataURI) {
      var bytes = dataURI.split(',')[0].indexOf('base64') >= 0 ? atob(dataURI.split(',')[1]) : unescape(dataURI.split(',')[1]);
      var mime = dataURI.split(',')[0].split(':')[1].split(';')[0];
      var max = bytes.length;
      var ia = new Uint8Array(max);
      for (var i = 0; i < max; i++) ia[i] = bytes.charCodeAt(i);
      return new Blob([ia], { type: mime });
    }

    function resize() {
      var width = image.width;
      var height = image.height;
      if (width > height) {
        if (width > maxSize) {
          height *= maxSize / width;
          width = maxSize;
        }
      } else {
        if (height > maxSize) {
          width *= maxSize / height;
          height = maxSize;
        }
      }
      canvas.width = width;
      canvas.height = height;
      canvas.getContext('2d').drawImage(image, 0, 0, width, height);
      var dataUrl = canvas.toDataURL('image/jpeg');
      return dataURItoBlob(dataUrl);
    }

    return new Promise(function (ok, no) {
      if (!file.type.match(/image.*/)) {
        no(new Error('Not an image'));
        return;
      }
      reader.onload = function (readerEvent) {
        image.onload = function () {
          return ok(resize());
        };
        image.src = readerEvent.target.result;
      };
      reader.readAsDataURL(file);
    });
  }

  function scrollUp() {
    document.body.scrollTop = 0; // Safari
    document.documentElement.scrollTop = 0; // Chrome, Firefox, IE and Opera
  }

</script>

<style>
.loader,
.loader:after {
  border-radius: 50%;
  width: 10em;
  height: 10em;
}
.loader {
  margin: 1rem auto;
  font-size: 4px;
  position: relative;
  text-indent: -9999em;
  border-top: 1.4em solid #0E0E0E;
  border-right: 1.4em solid rgba(161, 161, 161, 0.2);
  border-bottom: 1.4em solid rgba(161, 161, 161, 0.2);
  border-left: 1.4em solid rgba(161, 161, 161, 0.2);
  -webkit-transform: translateZ(0);
  -ms-transform: translateZ(0);
  transform: translateZ(0);
  -webkit-animation: load8 1.1s infinite linear;
  animation: load8 1.1s infinite linear;
}
@-webkit-keyframes load8 {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
@keyframes load8 {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
</style>