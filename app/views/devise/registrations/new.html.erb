<div class="container">
  <h2 class="title-signup text-center">Inscription</h2>
  <div class="row justify-content-center align-items-center">
    <div class="input-signup col-md-5">

      <%= simple_form_for(resource, as: resource_name, url: registration_path(resource_name)) do |f| %>
        <%= f.error_notification %>

        <div class="form-inputs">
          <%= f.input :first_name, label: 'Prénom', autofocus: true %>
          <%= f.input :last_name, label: 'Nom de famille' %>
          <%= f.input :email,
                      required: true,
                      input_html: { autocomplete: "email" }%>
          
          <%= f.input :date_of_birth, as: :date, input_html: { 
                  min: "#{Time.now.year - 80}-#{Time.now.month}-#{Time.now.day}", 
                  max: "#{Time.now.year - 14}-#{Time.now.month}-#{Time.now.day}",
                },
                html5: true,
                required: true,
                hint: "Tu dois être majeur si tu veux vendre tes paires",
                label: 'Date de naissance'
            %>
          
            <%= f.input :iban, label: "Remplir mon IBAN", placeholder: "FR1420041010050500013M02606" %>
            <div id="iban-error"></div>

          <%= f.input :password, label: "Mot de passe",
                      required: true,
                      hint: ("#{@minimum_password_length} characters minimum" if @minimum_password_length),
                      input_html: { autocomplete: "new-password" } %>
          <%= f.input :password_confirmation, label: "Confirmation du mot de passe",
                      required: true,
                      input_html: { autocomplete: "new-password" } %>
        </div>

        <!-- <div class="form-actions"> -->
          <%= f.button :submit, "S'inscrire", class: "text-center btn btn-dark sign-up-user", id: "btn-submit" %>
        <!-- </div> -->
      <% end %>
    </div>
    
    <!-- <div class="col-md-5 omniauth text-left"> -->
      <%#= render "devise/shared/links" %>
    <!-- </div> -->
  
  </div>

  <div class="signin-btn">
    <%- if controller_name != 'sessions' %>
      <%= link_to "Se connecter", new_session_path(resource_name) %>
    <% end %>
  </div>

</div>


<script type="text/javascript">
document.addEventListener('turbolinks:load', () => {
  function smellsLikeIban(str){
   return /^([A-Z]{2}[ \-]?[0-9]{2})(?=(?:[ \-]?[A-Z0-9]){9,30}$)((?:[ \-]?[A-Z0-9]{3,5}){2,7})([ \-]?[A-Z0-9]{1,3})?$/.test(str);
  }

  function validateIbanChecksum(iban) {       
    const ibanStripped = iban.replace(/[^A-Z0-9]+/gi,'') //keep numbers and letters only
                             .toUpperCase(); //calculation expects upper-case
    const m = ibanStripped.match(/^([A-Z]{2})([0-9]{2})([A-Z0-9]{9,30})$/);
    if(!m) return false;
    
    const numbericed = (m[3] + m[1] + m[2]).replace(/[A-Z]/g,function(ch){
                          //replace upper-case characters by numbers 10 to 35
                          return (ch.charCodeAt(0)-55); 
                      });
    const mod97 = numbericed.match(/\d{1,7}/g)
                            .reduce(function(total, curr){ return Number(total + curr)%97},'');

    return (mod97 === 1);
  };

  let button = document.querySelector('.sign-up-user');
  const errorElement = document.getElementById("iban-error");
  const ibanForm = document.getElementById('user_iban');
  if (button && errorElement && ibanForm) {
    button.addEventListener('click', (event) => {
      let message = [];
      user_iban = document.getElementById('user_iban').value;
      if (user_iban != "")
      {
        if (smellsLikeIban(user_iban) == false || validateIbanChecksum(user_iban) == false)
          message.push("L'IBAN n'est pas valide");
        else if (smellsLikeIban(user_iban) == true && validateIbanChecksum(user_iban) == true)
          message.push("L'IBAN est valide !");
        if (message == "L'IBAN n'est pas valide")
        {
          event.preventDefault();
          errorElement.innerText = message.join(', ');
          errorElement.style.color = "red";
          ibanForm.style.border = "solid 0.1em";
          ibanForm.style.borderColor = "red";
          ibanForm.style.boxShadow = "inset 0px 0px 40px 40px #ffb2b2";

        }
        else if (message == "L'IBAN est valide !")
        {
          errorElement.innerText = message.join(', ');
          errorElement.style.color = "green";
          ibanForm.style.border = "solid 0.1em";
          ibanForm.style.borderColor = "green";
          ibanForm.style.boxShadow = "inset 0px 0px 40px 40px #ffffff";
        }
      }
    });
  };
});


</script>