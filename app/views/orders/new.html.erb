<title>Achat de <%= @sneaker.sneaker_db.name %> - Rock Don't Stock</title>
<div class="container">
  <%= link_to :back, class: "back-button" do %>
    <h2><i class="fas fa-arrow-left ms-0"></i> Commander</h2>
  <% end %>
  <div class="purchase">
    <div class="purchase-recap__card__sneaker is-mobile">
      <%= cl_image_tag(@sneaker.photos.first&.key, class: 'purchase-recap__card__sneaker-photo') %>
      <div class="purchase-recap__card__sneaker-details">
        <div class="purchase-recap__card__sneaker-name">
          <%= @sneaker.sneaker_db.name %>
        </div>
        <div class="purchase-recap__card__sneaker-options">
          <%= @sneaker.sneaker_db.category %> - Taille <%= @sneaker.size %> - Condition: <%= @sneaker.condition %>/10
        </div>
        <div class="purchase-recap__card__sneaker-price">
          <%= @sneaker.price %> €
        </div>
      </div>
    </div>
    <%= form_for :order, data: { secret: @intent.client_secret }, html: { id: "payment-form", style: "flex-grow: 1.5" } do |f| %>
      <%= f.hidden_field :sneaker_id, value: @sneaker.id %>
      <%= f.hidden_field :payment_intent_id, value: @intent.id %>
      <div class="purchase-form__infos">
        <div class="purchase-form__infos__title">
          <%= image_tag("images/icon_shopping.svg") %>
          <span class="ms-2">Informations de contact</span>
        </div>
        <div class="purchase-form__infos__fields">
          <div class="row g-2">
            <div class="col-12 col-lg-5">
              <%= f.label "Nom", class: "form-label" %>
              <%= f.text_field :last_name, class: "form-control", required: true %>
            </div>
            <div class="col-12 col-lg-5">
              <%= f.label "Prénom", class: "form-label" %>
              <%= f.text_field :first_name, class: "form-control", required: true %>
            </div>
          </div>
          <div class="row g-2">
            <div class="col-12 col-lg-5">
              <%= f.label "Téléphone", class: "form-label" %>
              <%= f.text_field :phone, class: "form-control", required: true %>
            </div>
            <div class="col-12 col-lg-5">
              <%= f.label "E-mail", class: "form-label" %>
              <%= f.email_field :email, class: "form-control", value: current_user.email, disabled: true %>
            </div>
          </div>
        </div>
      </div>
      <div class="purchase-form__shipping">
        <div class="purchase-form__shipping__title">
          <%= image_tag("images/icon_truck.svg", width: "24", height: "24") %>
          <span class="ms-2">Méthode de livraison</span>
        </div>
        <div class="purchase-form__shipping__fields">
          <div class="row g-2 ms-0">
            <div class="col-auto form-check me-3">
              <%= f.radio_button :delivery, :colissimo, { class: "form-check-input", checked: true } %>
              <%= f.label "Colissimo", class: "form-check-label" %>
            </div>
            <div class="col-auto form-check">
              <%= f.radio_button :delivery, :relay, { class: "form-check-input" } %>
              <%= f.label "Mondial Relay", class: "form-check-label" %>
            </div>
          </div>
          <div class="purchase-form__shipping__relay">
            <div class="purchase-form__shipping__relay-target">
              <%= image_tag("images/map-pin.svg") %>
              <div>
                <div class="purchase-form__shipping__relay-target-address"></div>
                <div class="purchase-form__shipping__relay-target-city"></div>
                <div class="purchase-form__shipping__relay-btn">Changer</div>
              </div>
            </div>
            <div class="purchase-form__shipping__relay-map"></div>
            <%= f.hidden_field :relay_address, class: "purchase-form__shipping__relay-coords" %>
            <input type="hidden" id="purchase-form__shipping__relay-id" />
          </div>
          <div class="purchase-form__shipping__address">          
            <div class="row g-2">
              <div class="col-12 col-lg-5">
                <%= f.label "Adresse", class: "form-label" %>
                <%= f.text_field :address, class: "form-control", required: true %>
              </div>
              <div class="col-12 col-lg-5">
                <%= f.label "Ville", class: "form-label" %>
                <%= f.text_field :city, class: "form-control", required: true %>
              </div>
            </div>
            <div class="row g-2">
              <div class="col-12 col-lg-5">
                <%= f.label "Code postal", class: "form-label" %>
                <%= f.text_field :zip_code, class: "form-control", required: true %>
              </div>
              <div class="col-12 col-lg-5">
                <%= f.label "Numéro de porte", class: "form-label" %>
                <%= f.text_field :door_number, class: "form-control", required: true %>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="purchase-form__payment col-12 col-lg-10">
        <div class="purchase-form__payment__title">
          <%= image_tag("images/icon_bill.svg") %>
          <span class="ms-2">Moyen de paiement</span>
        </div>
        <div class="purchase-form__payment__fields">
          <div id="payment-element">
            <!-- Elements will create form elements here -->
          </div>
          <div id="error-message">
            <!-- Display error message to your customers here -->
          </div>
        </div>
      </div>
      <!-- MOBILE -->
      <div class="purchase-recap__card__title is-mobile">
        Ma commande
      </div>
      <div class="purchase-recap__card__order-infos is-mobile">
        <div class="purchase-recap__card__order-infos__item">
          <div>Livraison</div>
          <div id="shipping-fee">9.15 €</div>
        </div>
        <div class="purchase-recap__card__order-infos__item">
          <div>Authentification Premium</div>
          <div><%= 0.06 * @sneaker.price %> €</div>
        </div>
        <div class="purchase-recap__card__order-infos__item">
          <div>Code promo</div>
          <div>-0 €</div>
        </div>
      </div>
      <div class="purchase-recap__card__total is-mobile">
        <div>Total</div>
        <div id="total-price"><%= (@sneaker.price_cents + 915) / 100 %> €</div>
      </div>
      <div class="purchase-form__validation">
        <button class="purchase-form__validation__btn">Valider ma commande</button>
        <div class="form-check">
          <%= f.check_box :legal, { class: "form-check-input", required: true }, 1, nil %>
          <%= f.label "", class: "form-check-label" do %>
            En confirmant ma commande j'accepte les <a href="/cgv">conditions générales de vente</a>.
          <% end %>
        </div>
      </div>
    <% end %>
    <!-- DESKTOP -->
    <div class="purchase-recap">
      <div class="purchase-recap__card">
        <div class="purchase-recap__card__title">
          Ma commande
        </div>
        <div class="purchase-recap__card__sneaker">
          <%= cl_image_tag(@sneaker.photos.first&.key, class: 'purchase-recap__card__sneaker-photo') %>
          <div class="purchase-recap__card__sneaker-details">
            <div class="purchase-recap__card__sneaker-name">
              <%= @sneaker.sneaker_db.name %>
            </div>
            <div class="purchase-recap__card__sneaker-options">
              <%= @sneaker.sneaker_db.category %> - Taille <%= @sneaker.size %> - Condition: <%= @sneaker.condition %>/10
            </div>
            <div class="purchase-recap__card__sneaker-price">
              <%= @sneaker.price %> €
            </div>
          </div>
        </div>
        <div class="purchase-recap__card__order-infos">
          <div class="purchase-recap__card__order-infos__item">
            <div>Livraison</div>
            <div id="shipping-fee">9.15 €</div>
          </div>
          <div class="purchase-recap__card__order-infos__item">
            <div>Authentification Premium</div>
            <div><%= 0.06 * @sneaker.price %> €</div>
          </div>
          <div class="purchase-recap__card__order-infos__item">
            <div>Code promo</div>
            <div>-0 €</div>
          </div>
        </div>
        <div class="purchase-recap__card__total">
          <div>Total</div>
          <div id="total-price"><%= (@sneaker.price_cents + 915) / 100 %> €</div>
        </div>
        <div class="purchase-recap__card__trustpilot"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(event) {

  const radioRelay = document.getElementById('order_delivery_relay');
  const radioColissimo = document.getElementById('order_delivery_colissimo');
  const relayMap = document.querySelector('.purchase-form__shipping__relay-map');
  const colissimoBlock = document.querySelector('.purchase-form__shipping__address');
  const relayBlock = document.querySelector('.purchase-form__shipping__relay');
  const relayChangeBtn = document.querySelector('.purchase-form__shipping__relay-btn');
  const shippingFee = document.getElementById('shipping-fee');
  const totalPrice = document.getElementById('total-price');

  [radioRelay, radioColissimo].forEach((radio) => {
    radio.addEventListener('change', function() {
      if (this === radioRelay) {
        relayBlock.style.display = "block"
        colissimoBlock.style.display = "none"
        colissimoBlock.querySelectorAll('input').forEach(input => input.required = false)
        shippingFee.innerText = "6.30 €"
        totalPrice.innerText = "<%= (@sneaker.price_cents * 1.06 + 630) / 100 %> €"
      }
      if (this === radioColissimo) {
        relayBlock.style.display = "none"
        colissimoBlock.style.display = "block"
        colissimoBlock.querySelectorAll('input').forEach(input => input.required = true)
        shippingFee.innerText = "9.15 €"
        totalPrice.innerText = "<%= (@sneaker.price_cents * 1.06 + 915) / 100 %> €"
      }
    });
  })

  relayChangeBtn.addEventListener('click', () => {
    relayMap.style.display = "block"
  })

  // STRIPE
  const stripe = Stripe("<%= ENV['STRIPE_PUBLIC_TEST'] %>");

  const options = {
    clientSecret: '<%= @intent.client_secret %>',
    appearance: {
      theme: 'flat',
      rules: {
        '.Input:hover': {
          outline: '1px solid rgba(100, 100, 100, 0.25)'
        },
      },
      variables: {
        colorPrimary: '#0E0E0E',
        colorText: '#0E0E0E',
        spacingUnit: '4px',
        borderRadius: '0',
        focusBoxShadow: '0 0 0 0.2rem rgba(100, 100, 100, 0.25)'
      }
    },
  };

  const elements = stripe.elements(options);
  const paymentElement = elements.create('payment');
  paymentElement.mount('#payment-element');

  const form = document.getElementById('payment-form');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    let formData = new FormData(form);

    Rails.ajax({
      type: "POST",
      url: "<%= sneaker_orders_url(@sneaker.id) %>",
      data: formData,
      success: (resp) => {
        handlePayment(resp.orderId)
      },
      error: () => alert("Une erreur est survenue.")
    })

    async function handlePayment(orderId) {
      const {error} = await stripe.confirmPayment({
        elements,
        confirmParams: {
          return_url: "<%= sneaker_payment_complete_url %>" + "?order_id=" + orderId
        },
      });
  
      if (error) {
        const messageContainer = document.querySelector('#error-message');
        messageContainer.textContent = error.message;
      }
    }
  })
});
</script>
