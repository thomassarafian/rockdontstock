<div class="container tranfers-index">  
  <h1>Vérification des documents d'identité & virements bancaires</h1>
  <% if current_user.stripe_account_id.present? %>
    <div class="send-id-documents">
      <h2>Envoyez mes documents</h2>
      <p>Si tu vends des paires sur le site, tu devras nous transférer le recto et verso de ta carte d'identité ainsi qu'un justificatif de domicile.<br>Cela nous permet d'éviter les fraudes et de travailler uniquement avec des vendeurs fiables.</p>
      <div>
        <form method="post" class="my-form" id="fileinfo" name="fileinfo" ajax="true">
          <label><strong>Recto de ma carte d'identité :</strong></label>
          <input type="hidden" name="file-front-hid" id="file-front-hid">
          <input type="file" id="file-front" name="file" required />
          <!-- <br> -->
          <label><strong>Verso de ma carte d'identité :</strong></label>
          <input type="hidden" name="file-back-hid" id="file-back-hid">
          <input type="file" id="file-back" name="file" required />
          <!-- <br> -->
          <label><strong>Justificatif de domicile :</strong></label>
          <input type="hidden" name="file-home-hid" id="file-home-hid">
          <input type="file" id="file-home" name="file" required />
          <!-- <br> -->
          
          <button  type="submit" class="btn-send-documents btn btn-dark">Envoyer mes document</button>

          <!-- <button type="submit" value="Envoyer mes document" ></button> -->
          <!-- <input type="submit" value="Envoyer mes document" /> -->
        </form>
      </div>
    </div>
  <% else %>
    <p>Il s'emballerait que tu ne sois pas un vendeur !<br>Cette page permet de vérifier l'authenticité des vendeurs sur notre site ainsi que de leurs permettre de transférer de l'argent directement sur leurs compte bancaires. </p>
  <% end %>



  <div class="">
    <h2>Tous mes virements</h2>
    <p>Si tu as fait une vente, félicitations !<br>Tu peux désormais préremplir ton IBAN. <br>C'est aussi sur cette page que tu verras la somme que tu pourras retirer.</p>
    <div class='form-validate-iban'>
      <%= simple_form_for(current_user) do |f| %>
        <%= f.input :iban, label: "Remplir mon IBAN", placeholder: "FR1420041010050500013M02606" %>
        <%= f.button :submit, "Enregistrer mon IBAN", class: 'btn-save-iban btn btn-dark', id: 'btn-validate-iban' %>
      <% end %>
      <div id="iban-error"></div>
    </div>


   

    <h2>En attente :</h2>
    <% if  @balance.pending[0].amount > 0 %>
      <p>Mon solde est de <%= @balance.pending[0].amount / 100 %> euros. Je pourrai retirer cet argent dans 7 jours ouvrés. </p>
    <% elsif  @balance.pending[0].amount == 0 %>
      <p>Mon solde est de 0 euro, je ne peux rien retirer</p>
    <% end %>

    <h2>Disponible :</h2>
    <% if  @balance.available[0].amount > 0 %>
      <p>Mon solde est de <%= @balance.available[0].amount / 100 %> euros</p>
      <button>Retirer l'intégraliter</button>
    <% elsif  @balance.available[0].amount == 0 %>
      <p>Mon solde est de 0 euro, je ne peux rien retirer</p>
    <% end %>
  </div>
</div>

<script type="text/javascript">
  
  function smellsLikeIban(str){
 return /^([A-Z]{2}[ \-]?[0-9]{2})(?=(?:[ \-]?[A-Z0-9]){9,30}$)((?:[ \-]?[A-Z0-9]{3,5}){2,7})([ \-]?[A-Z0-9]{1,3})?$/.test(str);
}

function validateIbanChecksum(iban) {       
  const ibanStripped = iban.replace(/[^A-Z0-9]+/gi,'') //keep numbers and letters only
                           .toUpperCase(); //calculation expects upper-case
  const m = ibanStripped.match(/^([A-Z]{2})([0-9]{2})([A-Z0-9]{9,30})$/);
  if(!m) return false;
  
  const numbericed = (m[3] + m[1] + m[2]).replace(/[A-Z]/g,function(ch){
                        //replace upper-case characters by numbers 10 to 35
                        return (ch.charCodeAt(0)-55); 
                    });
  const mod97 = numbericed.match(/\d{1,7}/g)
                          .reduce(function(total, curr){ return Number(total + curr)%97},'');

  return (mod97 === 1);
};

const button = document.querySelector('#btn-validate-iban');
const errorElement = document.getElementById("iban-error");

const ibanForm = document.getElementById('user_iban');

button.addEventListener('click', (event) => {
  let message = [];
  user_iban = document.getElementById('user_iban').value;
  if (user_iban != "")
  {
    if (smellsLikeIban(user_iban) == false || validateIbanChecksum(user_iban) == false)
      message.push("L'IBAN n'est pas valide");
    else if (smellsLikeIban(user_iban) == true && validateIbanChecksum(user_iban) == true)
      message.push("L'IBAN est valide !");
    if (message == "L'IBAN n'est pas valide")
    {
      event.preventDefault();
      errorElement.innerText = message.join(', ');
      errorElement.style.color = "red";
      ibanForm.style.border = "solid 0.1em";
      ibanForm.style.borderColor = "red";
      ibanForm.style.boxShadow = "inset 0px 0px 40px 40px #ffb2b2";

    }
    else if (message == "L'IBAN est valide !")
    {
      errorElement.innerText = message.join(', ');
      errorElement.style.color = "green";
      ibanForm.style.border = "solid 0.1em";
      ibanForm.style.borderColor = "green";
      ibanForm.style.boxShadow = "inset 0px 0px 40px 40px #ffffff";
    }
  }
});


</script>